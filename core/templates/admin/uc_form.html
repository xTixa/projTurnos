{% extends "../home/base.html" %}

{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin/uc_form.css' %}">

<div class="uc-container">
	<h1>
		<i class="fa-solid fa-book"></i>
		{% if uc %}Editar UC — {{ uc.nome }}{% else %}Nova Unidade Curricular{% endif %}
	</h1>

	{% if uc %}
	<p class="uc-meta">
		<strong>ID:</strong> {{ uc.id_unidadecurricular }} · 
		<strong>ECTS:</strong> {{ uc.ects }} · 
		<strong>Ano:</strong> {{ uc.id_anocurricular.ano_curricular }} · 
		<strong>Semestre:</strong> {{ uc.id_semestre.semestre }}º · 
		<strong>Curso:</strong> {{ uc.id_curso.nome }}
	</p>
	{% endif %}

	<div class="uc-grid">
		<!-- Formulário Principal -->
		<div class="uc-card">
			<h2><i class="fa-solid fa-pen"></i> Dados da UC</h2>
			<form method="post" class="uc-form">
				{% csrf_token %}
				<input type="hidden" name="action" value="update_uc">

				<div class="form-group">
					<label for="nome">Nome</label>
					<input type="text" id="nome" name="nome" value="{% if uc %}{{ uc.nome }}{% endif %}" required>
				</div>

				<div class="form-group">
					<label for="ects">ECTS</label>
					<input type="number" step="0.5" min="0" id="ects" name="ects" value="{% if uc %}{{ uc.ects|stringformat:"g" }}{% endif %}" required>
				</div>

				<div class="form-group">
					<label for="curso">Curso</label>
					<select name="curso" id="curso" required>
						<option value="">Selecionar Curso</option>
						{% for c in cursos %}
						<option value="{{ c.id_curso }}" {% if uc and uc.id_curso.id_curso == c.id_curso %}selected{% endif %}>{{ c.nome }}</option>
						{% endfor %}
					</select>
				</div>

				<div class="form-group">
					<label for="ano">Ano Curricular</label>
					<select name="ano" id="ano" required>
						<option value="">Selecionar Ano</option>
						{% for a in anos %}
						<option value="{{ a.id_anocurricular }}" {% if uc and uc.id_anocurricular.id_anocurricular == a.id_anocurricular %}selected{% endif %}>{{ a.ano_curricular }}</option>
						{% endfor %}
					</select>
				</div>

				<div class="form-group">
					<label for="semestre">Semestre</label>
					<select name="semestre" id="semestre" required>
						<option value="">Selecionar Semestre</option>
						{% for s in semestres %}
						<option value="{{ s.id_semestre }}" {% if uc and uc.id_semestre.id_semestre == s.id_semestre %}selected{% endif %}>{{ s.semestre }}º Semestre</option>
						{% endfor %}
					</select>
				</div>

				<div class="form-actions">
					<button type="submit" class="btn btn-primary">
						<i class="fa-solid fa-save"></i> Guardar
					</button>
					<a href="{% url 'home:admin_uc_list' %}" class="btn btn-secondary">
						<i class="fa-solid fa-arrow-left"></i> Voltar
					</a>
				</div>
			</form>
		</div>

		<!-- Turnos -->
		{% if uc %}
		<div class="uc-card">
			<h2><i class="fa-solid fa-users"></i> Turnos ({{ turnos_uc|length }})</h2>
			
			{% if turnos_uc and turnos_uc|length > 0 %}
			<table class="turnos-table">
				<thead>
					<tr>
						<th>Nº</th>
						<th>Tipo</th>
						<th>Cap.</th>
						<th>Horário</th>
						<th></th>
					</tr>
				</thead>
				<tbody>
					{% for t in turnos_uc %}
					<tr>
						<td><strong>{{ t.id_turno.n_turno }}</strong></td>
						<td><span class="badge badge-tipo">{{ t.id_turno.tipo }}</span></td>
						<td>{{ t.id_turno.capacidade }}</td>
						<td>{{ t.hora_inicio|default_if_none:"—" }} - {{ t.hora_fim|default_if_none:"—" }}</td>
						<td class="actions-cell">
							<form method="post" style="display:inline;">
								{% csrf_token %}
								<input type="hidden" name="action" value="delete_turno">
								<input type="hidden" name="turno_id" value="{{ t.id_turno.id_turno }}">
								<button type="submit" class="btn btn-danger" onclick="return confirm('Remover este turno?');">
									<i class="fa-solid fa-trash"></i>
								</button>
							</form>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			{% else %}
			<p class="empty-state">Não existem turnos associados a esta UC.</p>
			{% endif %}

			<div class="turnos-section">
				<h3><i class="fa-solid fa-plus-circle"></i> Adicionar Turno</h3>
				<form method="post" class="add-turno-form">
					{% csrf_token %}
					<input type="hidden" name="action" value="add_turno">
					
					<div class="form-group">
						<label for="n_turno">Nº Turno</label>
						<input type="text" name="n_turno" id="n_turno" required>
					</div>
					
					<div class="form-group">
						<label for="tipo">Tipo</label>
						<select name="tipo" id="tipo" required>
							<option value="">Selecionar tipo</option>
							<option value="T">Teórico</option>
							<option value="TP">Teórico-Prático</option>
							<option value="PL">Laboratório</option>
						</select>
					</div>
					
					<div class="form-group">
						<label for="capacidade">Capacidade</label>
						<input type="number" name="capacidade" id="capacidade" min="1" required>
					</div>
					
					<div class="form-group">
						<label for="hora_inicio">Hora Início</label>
						<input type="time" name="hora_inicio" id="hora_inicio" required>
					</div>
					
					<div class="form-group">
						<label for="hora_fim">Hora Fim</label>
						<input type="time" name="hora_fim" id="hora_fim" required>
					</div>
					
					<div class="form-group full-width">
						<button type="submit" class="btn btn-success">
							<i class="fa-solid fa-plus"></i> Adicionar Turno
						</button>
					</div>
				</form>
			</div>
		</div>
		{% endif %}
	</div>
</div>

{% endblock %}
