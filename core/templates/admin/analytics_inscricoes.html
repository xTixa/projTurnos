{% extends "home/base.html" %}
{% load static %}

{% block title %}Analytics — Inscrições{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin/analytics.css' %}">
{% endblock %}

{% block content %}
<div class="analytics-container">
  <!-- HEADER -->
  <div class="analytics-header">
    <h1><i class="fa-solid fa-chart-line"></i> Analytics — Inscrições em Turnos</h1>
    <p>Visualize métricas e estatísticas de inscrições</p>
  </div>

  <!-- CHARTS SECTION -->
  <div class="charts-section">
    <div class="chart-card">
      <div class="chart-header">
        <h3><i class="fa-solid fa-pie-chart"></i> Taxa de Sucesso</h3>
      </div>
      <canvas id="taxa-sucesso-chart"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <h3><i class="fa-solid fa-line-chart"></i> Inscrições por Dia</h3>
      </div>
      <canvas id="inscricoes-dia-chart"></canvas>
    </div>
  </div>

  <!-- TABLES SECTION -->
  <div class="tables-section">
    <!-- Alunos Mais Ativos -->
    <div class="table-card">
      <div class="table-header">
        <h3><i class="fa-solid fa-fire"></i> Top 10 Alunos Mais Ativos</h3>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Aluno</th>
              <th>Tentativas</th>
              <th>Sucessos</th>
              <th>Taxa de Sucesso</th>
            </tr>
          </thead>
          <tbody>
            {% for aluno in alunos_ativos %}
            <tr>
              <td><span class="badge">{{ forloop.counter }}</span></td>
              <td>{{ aluno.aluno_id }}</td>
              <td><strong>{{ aluno.total_tentativas }}</strong></td>
              <td><strong>{{ aluno.sucessos }}</strong></td>
              <td>
                <div class="progress-bar">
                  <div class="progress-fill" style="width: {{ aluno.taxa_sucesso }}%"></div>
                  <span class="progress-text">{{ aluno.taxa_sucesso|floatformat:1 }}%</span>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="5" class="empty-state">Sem dados disponíveis</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- UCs Mais Procuradas -->
    <div class="table-card">
      <div class="table-header">
        <h3><i class="fa-solid fa-star"></i> Top 10 UCs Mais Procuradas</h3>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Unidade Curricular</th>
              <th>Tentativas</th>
              <th>Sucessos</th>
            </tr>
          </thead>
          <tbody>
            {% for uc in ucs_procuradas %}
            <tr>
              <td><span class="badge">{{ forloop.counter }}</span></td>
              <td>{{ uc.uc_nome }}</td>
              <td><strong>{{ uc.total_tentativas }}</strong></td>
              <td><strong>{{ uc.sucessos }}</strong></td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="empty-state">Sem dados disponíveis</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- OVERLOADED TURNOS -->
  <div class="overloaded-section">
    <div class="table-card full-width">
      <div class="table-header">
        <h3><i class="fa-solid fa-triangle-exclamation"></i> Turnos Sobrecarregados</h3>
        <p class="subtitle">Turnos com rejeições por limite de capacidade</p>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID Turno</th>
              <th>Rejeições por Limite</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for turno in turnos_cheios %}
            <tr>
              <td><strong>{{ turno.turno_id }}</strong></td>
              <td>
                <span class="status-badge high">{{ turno.rejeicoes_por_limite }}</span>
              </td>
              <td>
                {% if turno.rejeicoes_por_limite > 0 %}
                  <span class="alert-badge">⚠️ Crítico</span>
                {% else %}
                  <span class="ok-badge">✓ OK</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="empty-state">Sem dados de sobrecarga</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Configuração global dos gráficos
  Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
  Chart.defaults.font.size = 12;

  // Taxa de sucesso
  fetch('/api/analytics/taxa-sucesso/')
    .then(r => r.json())
    .then(data => {
      const ctx = document.getElementById('taxa-sucesso-chart');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.map(d => d._id),
          datasets: [{
            data: data.map(d => d.count),
            backgroundColor: [
              '#10b981', // verde
              '#ef4444', // vermelho
              '#f59e0b', // amarelo
              '#3b82f6', // azul
              '#6366f1', // indigo
              '#14b8a6'  // teal
            ],
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: { size: 12 }
              }
            }
          }
        }
      });
    })
    .catch(err => console.error('Erro ao carregar taxa de sucesso:', err));

  // Inscrições por dia
  fetch('/api/analytics/inscricoes-dia/')
    .then(r => r.json())
    .then(data => {
      const ctx = document.getElementById('inscricoes-dia-chart');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d._id),
          datasets: [{
            label: 'Inscrições Totais',
            data: data.map(d => d.total_tentativas),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 5,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointHoverRadius: 7
          }, {
            label: 'Sucessos',
            data: data.map(d => d.sucesso),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 5,
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                padding: 15,
                font: { size: 12 }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    })
    .catch(err => console.error('Erro ao carregar inscrições por dia:', err));
</script>
{% endblock %}
