{% extends "../home/base.html" %}

{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin/users_form.css' %}">

<div class="users-container">
    <h1>Gerir Utilizadores</h1>

    <!-- Botão para criar novo utilizador -->
    <div class="action-buttons">
        <a href="#novo-form" class="btn-create" id="btn-novo-user">+ Novo Utilizador</a>
    </div>

    <!-- FORMULÁRIO PARA CRIAR NOVO UTILIZADOR -->
    <div class="form-section" id="novo-form" style="display:none;">
        <h2>Novo Utilizador</h2>
        
        <form method="post" action="{% url 'home:admin_users_create' %}" class="user-form">
            {% csrf_token %}

            <!-- Campo TIPO -->
            <div class="form-group">
                <label for="tipo">Tipo de Utilizador:</label>
                <select id="tipo" name="tipo" required onchange="mostrarCamposEspecificos()">
                    <option value="admin">Admin</option>
                    <option value="aluno">Aluno</option>
                    <option value="docente">Docente</option>
                </select>
            </div>

            <!-- Campos para ALUNO -->
            <div id="campos-aluno" style="display: none;">
                <div class="form-group">
                    <label for="n_mecanografico">Nº Mecanografico:</label>
                    <input type="number" id="n_mecanografico" name="n_mecanografico">
                </div>
                
                <div class="form-group">
                    <label for="id_curso">Curso:</label>
                    <select id="id_curso" name="id_curso">
                        <option value="">-- Selecione um curso --</option>
                        {% for curso in cursos %}
                            <option value="{{ curso.id_curso }}">{{ curso.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="id_anocurricular">Ano Curricular:</label>
                    <select id="id_anocurricular" name="id_anocurricular">
                        <option value="">-- Selecione um ano --</option>
                        {% for ano in anos %}
                            <option value="{{ ano.id_anocurricular }}">{{ ano.ano_curricular }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="username">Username/Nome:</label>
                <input type="text" id="username" name="username" placeholder="Digite o username ou nome" required>
            </div>

            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" placeholder="Digite o email" required>
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" placeholder="Digite a password" required>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-save">Guardar</button>
                <button type="button" class="btn-cancel" onclick="toggleFormulario()">Cancelar</button>
            </div>
        </form>
    </div>

    <!-- LISTA DE UTILIZADORES -->
    <div class="list-section">
        <h2>Lista de Utilizadores</h2>

        <!-- FILTROS -->
        <div class="filter-options">
            <div class="filter-group">
                <label for="search-input">Pesquisar:</label>
                <input type="text" id="search-input" placeholder="Username ou email..." onkeyup="filtrarUtilizadores()">
            </div>
            
            <div class="filter-group">
                <label for="tipo-filter">Tipo:</label>
                <select id="tipo-filter" onchange="filtrarUtilizadores()">
                    <option value="">Todos</option>
                    <option value="Admin">Admin</option>
                    <option value="Aluno">Aluno</option>
                    <option value="Docente">Docente</option>
                </select>
            </div>

            <button type="button" class="btn-filter-reset" onclick="limparFiltros()">
                <i class="fa-solid fa-rotate-left"></i> Limpar Filtros
            </button>
        </div>

        {% if users %}
            <div class="table-info">
                <span>Total: <strong id="total-users">{{ users|length }}</strong> utilizador(es)</span>
                <span id="filtered-info" style="display:none; margin-left: 10px; color: #2563eb;"></span>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Tipo</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>

                <tbody>
                    {% for u in users %}
                    <tr>
                        <td><strong>{{ u.id }}</strong></td>
                        <td>{{ u.username }}</td>
                        <td>{{ u.email|default:"—" }}</td>
                        <td>
                            <span class="badge badge-{{ u.tipo|lower }}">{{ u.tipo }}</span>
                        </td>
                        <td>
                            {% if u.is_active %}
                                <span class="status-active">✓ Ativo</span>
                            {% else %}
                                <span class="status-inactive">✗ Inativo</span>
                            {% endif %}
                        </td>
                        <td class="actions-cell">
                            <a href="{% url 'home:admin_users_edit' u.id %}" class="btn-edit" title="Editar utilizador">
                                <i class="fa-regular fa-pen-to-square"></i> Editar
                            </a>
                            <a href="{% url 'home:admin_users_delete' u.id %}" class="btn-delete" 
                               onclick="return confirm('Tem a certeza que deseja apagar o utilizador {{ u.username }}?');" 
                               title="Apagar utilizador">
                                <i class="fa-solid fa-trash"></i> Apagar
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="no-data">Nenhum utilizador encontrado.</p>
        {% endif %}
    </div>
</div>

<script>
    // Toggle formulário
    function toggleFormulario() {
        var formSection = document.getElementById('novo-form');
        formSection.style.display = formSection.style.display === 'none' ? 'block' : 'none';
    }

    // Mostrar/esconder campos específicos por tipo
    function mostrarCamposEspecificos() {
        const tipo = document.getElementById('tipo').value;
        const camposAluno = document.getElementById('campos-aluno');
        
        if (tipo === 'aluno') {
            camposAluno.style.display = 'block';
            document.getElementById('n_mecanografico').required = true;
            document.getElementById('id_curso').required = true;
            document.getElementById('id_anocurricular').required = true;
        } else {
            camposAluno.style.display = 'none';
            document.getElementById('n_mecanografico').required = false;
            document.getElementById('id_curso').required = false;
            document.getElementById('id_anocurricular').required = false;
        }
    }

    // Clique no botão
    document.getElementById('btn-novo-user').addEventListener('click', function(e) {
        e.preventDefault();
        toggleFormulario();
    });

    // Filtrar utilizadores
    function filtrarUtilizadores() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const tipoFilter = document.getElementById('tipo-filter').value;
        const table = document.querySelector('.admin-table tbody');
        const rows = table.getElementsByTagName('tr');
        let visibleCount = 0;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const username = row.cells[1].textContent.toLowerCase();
            const email = row.cells[2].textContent.toLowerCase();
            const tipo = row.cells[3].textContent.trim();
            
            const matchSearch = username.includes(searchTerm) || email.includes(searchTerm);
            const matchTipo = tipoFilter === '' || tipo === tipoFilter;
            
            if (matchSearch && matchTipo) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }

        // Atualizar contador
        const filteredInfo = document.getElementById('filtered-info');
        if (searchTerm || tipoFilter) {
            filteredInfo.style.display = 'inline';
            filteredInfo.textContent = `(Filtrado: ${visibleCount})`;
        } else {
            filteredInfo.style.display = 'none';
        }
    }

    // Limpar filtros
    function limparFiltros() {
        document.getElementById('search-input').value = '';
        document.getElementById('tipo-filter').value = '';
        filtrarUtilizadores();
    }

    // Aplicar filtro inicial se vindo de uma página específica
    window.addEventListener('load', function() {
        const filterTipo = '{{ filter_tipo }}';
        if (filterTipo) {
            document.getElementById('tipo-filter').value = filterTipo;
            filtrarUtilizadores();
        }
    });
</script>

{% endblock %}
