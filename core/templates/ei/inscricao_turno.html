{% extends "home/base.html" %}
{% load static %}
{% block title %}Inscrição em Turnos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ei/inscricao_turno.css' %}">
{% endblock %}

{% block content %}

<section class="turno-header">
    <h1>Inscrição em Turnos</h1>
    <p>
        Seleciona a unidade curricular e o turno que pretendes frequentar.
        As vagas são atualizadas em tempo real.
    </p>
</section>

<section class="turnos-lista">

    {% for uc in unidades %}
    <div class="uc-card">

        <h3>{{ uc.nome }}</h3>

        <!-- FORMULÁRIO POR UC -->
        <form method="POST"
              action="{% url 'home:inscrever_turno' 0 uc.id %}"
              class="uc-turnos"
              onsubmit="this.action = this.action.replace('/0/', '/' + this.turno.value + '/');">

            {% csrf_token %}

            <label for="turno{{ forloop.counter }}">Selecionar Turno:</label>

            <select name="turno"
                    id="turno{{ forloop.counter }}"
                    class="turno-select"
                    required>

                <option value="" disabled selected>Escolhe um turno...</option>

                {% for t in uc.turnos %}
                <option value="{{ t.id }}"
                        {% if t.vagas == 0 or t.ja_inscrito %}disabled{% endif %}
                        class="{% if t.ja_inscrito %}option-inscrito{% elif t.vagas == 0 %}option-esgotado{% else %}option-vagas{% endif %}"
                        data-vagas="{{ t.vagas }}">
                    {{ t.nome }} — {{ t.horario }} —
                    {% if t.ja_inscrito %}
                        ✓ Já inscrito
                    {% elif t.vagas == 0 %}
                        Esgotado
                    {% else %}
                        {{ t.vagas }} vaga{{ t.vagas|pluralize:"s" }}
                    {% endif %}
                </option>
                {% endfor %}

            </select>

            <button type="submit"
                    class="btn btn-primary btn-inscrever"
                    {% if uc.turnos|length == 0 %}disabled{% endif %}>
                <i class="fa-solid fa-check"></i> Inscrever
            </button>

        </form>

        <!-- Informação de turnos inscritos -->
        {% with inscritos=uc.turnos|dictsort:"ja_inscrito"|last %}
            {% if uc.turnos|dictsort:"ja_inscrito"|length > 0 %}
            <div class="turnos-inscritos">
                <p class="inscrito-info">
                    <i class="fa-solid fa-circle-check"></i>
                    {% for t in uc.turnos %}
                        {% if t.ja_inscrito %}
                        Já estás inscrito em <strong>{{ t.nome }}</strong>
                        {% endif %}
                    {% endfor %}
                </p>
            </div>
            {% endif %}
        {% endwith %}

    </div>
    {% endfor %}

</section>

<h2>O teu horário</h2>

<div id="horarioContainer" class="horario-wrapper">
<table class="tabela-horario">
    <thead>
        <tr>
            <th>Hora</th>
            <th>Segunda</th>
            <th>Terça</th>
            <th>Quarta</th>
            <th>Quinta</th>
            <th>Sexta</th>
            <th>Sábado</th>
            <th>Domingo</th>
        </tr>
    </thead>
    <tbody>
        {% for hora in horas %}
        <tr>
            <td>{{ hora }}</td>
            {% for dia in dias %}
            <td id="{{ dia }}-{{ hora }}" class="slot"></td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<button id="exportPDF" class="export-btn">
    <i class="fa-solid fa-file-pdf"></i> Exportar horário em PDF
</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

{% endblock %}

{% block extra_scripts %}

<script src="{% static 'js/inscricao_turno.js' %}"></script>

<script>
document.getElementById("exportPDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const container = document.getElementById("horarioContainer");

    const canvas = await html2canvas(container, {
        scale: 3,
        backgroundColor: "#FFFFFF",
    });

    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    pdf.save("horario_personalizado.pdf");
});
</script>

{% endblock %}
