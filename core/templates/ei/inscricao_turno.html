{% extends "home/base.html" %}
{% load static %}
{% block title %}Inscrição em Turnos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ei/inscricao_turno.css' %}">
{% endblock %}

{% block content %}

<section class="turno-header">
    <h1>Inscrição em Turnos</h1>
    <p>
        Seleciona a unidade curricular e o turno que pretendes frequentar.
        As vagas são atualizadas em tempo real.
    </p>
</section>

<section class="turnos-lista">

    {% for uc in unidades %}
    <div class="uc-card">

        <h3>{{ uc.nome }}</h3>

        <!-- FORMULÁRIO POR UC -->
        <form method="POST"
              action="{% url 'home:inscrever_turno' 0 uc.id %}"
              class="uc-turnos"
              onsubmit="this.action = this.action.replace('/0/', '/' + this.turno.value + '/');">

            {% csrf_token %}

            <label for="turno{{ forloop.counter }}">Selecionar Turno:</label>

            <select name="turno"
                    id="turno{{ forloop.counter }}"
                    class="turno-select"
                    required>

                <option value="" disabled selected>Escolhe um turno...</option>

                {% for t in uc.turnos %}
                    <option value="{{ t.id }}"
                            {% if t.vagas == 0 or t.ja_inscrito %}disabled{% endif %}
                            class="{% if t.ja_inscrito %}option-inscrito{% elif t.vagas == 0 %}option-esgotado{% else %}option-vagas{% endif %}"
                            data-dia="{{ t.dia }}"
                            data-hora="{{ t.hora_inicio }}">
                        {{ t.nome }} — {{ t.horario }} —
                        {% if t.ja_inscrito %}
                            <i class="fa-solid fa-check"></i> Já inscrito
                        {% elif t.vagas == 0 %}
                            Esgotado
                        {% else %}
                            {{ t.vagas }} vaga{{ t.vagas|pluralize:"s" }}
                        {% endif %}
                    </option>
                {% endfor %}
            </select>

            <button type="submit"
                    class="btn btn-primary btn-inscrever"
                    {% if uc.turnos|length == 0 %}disabled{% endif %}>
                <i class="fa-solid fa-check"></i> Inscrever
            </button>

        </form>

        <!-- Informação de turnos inscritos -->
        {% with inscritos=uc.turnos|dictsort:"ja_inscrito"|last %}
            {% if uc.turnos|dictsort:"ja_inscrito"|length > 0 %}
            <div class="turnos-inscritos">
                <p class="inscrito-info">
                    <i class="fa-solid fa-circle-check"></i>
                    {% for t in uc.turnos %}
                        {% if t.ja_inscrito %}
                        Já estás inscrito em <strong>{{ t.nome }}</strong>
                        {% endif %}
                    {% endfor %}
                </p>
            </div>
            {% endif %}
        {% endwith %}

    </div>
    {% endfor %}

</section>

<h2>O teu horário</h2>

<div id="horarioContainer" class="horario-wrapper">
<table class="tabela-horario">
    <thead>
        <tr>
            <th>Hora</th>
            <th>Segunda</th>
            <th>Terça</th>
            <th>Quarta</th>
            <th>Quinta</th>
            <th>Sexta</th>
            <th>Sábado</th>
            <th>Domingo</th>
        </tr>
    </thead>
    <tbody>
        {% for hora in horas %}
        <tr>
            <td>{{ hora }}</td>
            {% for dia in dias %}
            <td id="{{ dia }}-{{ hora }}" class="slot"></td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<button id="exportPDF" class="export-btn">
    <i class="fa-solid fa-file-pdf"></i> Exportar horário em PDF
</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

{% endblock %}

{% block extra_scripts %}

<script src="{% static 'js/inscricao_turno.js' %}"></script>

<script>
// Dados dos turnos inscritos vindos do Django
const turnosInscritos = {{ turnos_horario|safe }};

console.log("Turnos inscritos:", turnosInscritos);

// Preencher o horário
turnosInscritos.forEach(aula => {
    const { uc_nome, turno_nome, tipo, dia, hora_inicio, hora_fim } = aula;
    
    // Calcular quantas células (slots de 30min) a aula ocupa
    const [hi_h, hi_m] = hora_inicio.split(':').map(Number);
    const [hf_h, hf_m] = hora_fim.split(':').map(Number);
    
    const inicio_minutos = hi_h * 60 + hi_m;
    const fim_minutos = hf_h * 60 + hf_m;
    const duracao_slots = (fim_minutos - inicio_minutos) / 30;
    
    // Encontrar a célula inicial
    const celula = document.getElementById(`${dia}-${hora_inicio}`);
    
    if (celula) {
        celula.innerHTML = `
            <div class="aula-bloco">
                <strong>${uc_nome}</strong><br>
                <span>${turno_nome} (${tipo})</span><br>
                <small>${hora_inicio} - ${hora_fim}</small>
            </div>
        `;
        celula.classList.add('ocupado');
        celula.rowSpan = duracao_slots;
        
        // Remover células seguintes que serão ocupadas pelo rowspan
        let proxima = celula.nextElementSibling;
        for (let i = 1; i < duracao_slots; i++) {
            if (proxima) {
                const proximaLinha = celula.parentElement.nextElementSibling;
                if (proximaLinha) {
                    const colIndex = Array.from(celula.parentElement.children).indexOf(celula);
                    const celulaRemover = proximaLinha.children[colIndex];
                    if (celulaRemover) celulaRemover.remove();
                }
            }
        }
    }
});

// Exportar PDF
document.getElementById("exportPDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const container = document.getElementById("horarioContainer");

    const canvas = await html2canvas(container, {
        scale: 3,
        backgroundColor: "#FFFFFF",
    });

    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    pdf.save("horario_personalizado.pdf");
});
</script>

{% endblock %}
