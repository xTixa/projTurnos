{% extends "home/base.html" %}
{% load static %}
{% block title %}Inscrição em Turnos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/ei/inscricao_turno.css' %}?v=remodel">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}

<div class="inscricao-container">

<header class="simple-header">
    <h1>Inscrição em Turnos</h1>
    <p>
        Seleciona a unidade curricular e o turno que pretendes frequentar.
        As vagas são atualizadas em tempo real.
    </p>
</header>


<!-- Alerta de conflitos -->
<div id="conflito-alert" class="alert alert-warning" style="display: none; margin-bottom: 20px;">
	<i class="fa-solid fa-triangle-exclamation"></i>
	<strong>Aviso de Conflito de Horário</strong>
	<p id="conflito-msg"></p>
</div>

<section class="turnos-lista">

    {% for uc in unidades %}
    <div class="uc-card">

        <h3>{{ uc.nome }}</h3>

        <!-- FORMULÁRIO POR UC -->
        <form method="POST"
              id="form-uc-{{ uc.id }}"
              class="uc-turnos"
              onsubmit="return validarInscricao(this);">

            {% csrf_token %}

            <label for="turno{{ forloop.counter }}">Selecionar Turno:</label>

            <select name="turno"
                    id="turno{{ forloop.counter }}"
                    class="turno-select"
                    required>

                <option value="" disabled selected>Escolhe um turno...</option>

                {% for t in uc.turnos %}
                        <option value="{{ t.id }}"
                            {% if t.vagas == 0 or t.ja_inscrito %}disabled{% endif %}
                            class="{% if t.ja_inscrito %}option-inscrito{% elif t.vagas == 0 %}option-esgotado{% else %}option-vagas{% endif %}"
                            data-dia="{{ t.dia }}"
                            data-hora="{{ t.hora_inicio }}"
                            data-hora-fim="{{ t.hora_fim }}"
                            data-uc-id="{{ uc.id }}"
                            data-uc-nome="{{ uc.nome }}"
                            data-tipo="{{ t.tipo }}"
                            data-turno-nome="{{ t.nome }}">
                        {{ t.nome }} ({{ t.horario }})
                        {% if t.ja_inscrito %} — INSCRITO
                        {% elif t.vagas == 0 %} — ESGOTADO
                        {% else %} — {{ t.vagas }} vaga{{ t.vagas|pluralize:"s" }}
                        {% endif %}
                    </option>
                {% endfor %}
            </select>

            <button type="submit"
                    class="btn btn-primary btn-inscrever"
                    {% if uc.turnos|length == 0 %}disabled{% endif %}>
                <i class="fa-solid fa-check"></i> Inscrever
            </button>

        </form>

        <!-- Informação de turnos inscritos com opção de desinscrever -->
        {% for t in uc.turnos %}
            {% if t.ja_inscrito %}
            <div class="turnos-inscritos">
                <p class="inscrito-info">
                    <i class="fa-solid fa-circle-check"></i>
                    Já estás inscrito em <strong>{{ t.nome }}</strong> ({{ t.horario }})
                          <a href="{% url 'home:desinscrever_turno' t.id uc.id %}" 
                              class="btn-remover" 
                              data-turno-id="{{ t.id }}"
                              data-uc-id="{{ uc.id }}"
                              data-uc-nome="{{ uc.nome }}"
                              data-turno-nome="{{ t.nome }}"
                              data-tipo="{{ t.tipo }}"
                              data-dia="{{ t.dia }}"
                              data-hora-inicio="{{ t.hora_inicio }}"
                              data-hora-fim="{{ t.hora_fim }}"
                              onclick="return confirm('Desinscrever deste turno?');">
                        <i class="fa-solid fa-trash"></i> Remover
                    </a>
                </p>
            </div>
            {% endif %}
        {% endfor %}

    </div>
    {% endfor %}

</section>

<h2>O teu horário</h2>

<div id="horarioContainer" class="horario-wrapper">
<table class="tabela-horario">
    <thead>
        <tr>
            <th>Hora</th>
            <th>Segunda</th>
            <th>Terça</th>
            <th>Quarta</th>
            <th>Quinta</th>
            <th>Sexta</th>
            <th>Sábado</th>
            <th>Domingo</th>
        </tr>
    </thead>
    <tbody>
        {% for hora in horas %}
        <tr>
            <td>{{ hora }}</td>
            {% for dia in dias %}
            <td id="{{ dia }}-{{ hora }}" class="slot"></td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<button id="exportPDF" class="export-btn">
    <i class="fa-solid fa-file-pdf"></i> Exportar horário em PDF
</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</div>
{% endblock %}

{% block extra_scripts %}

<script src="{% static 'js/inscricao_turno.js' %}"></script>

<script>
// Dados dos turnos inscritos vindos do Django
let turnosInscritos = {{ turnos_horario|safe }};
let horarioAtualizado = false;

// Função para atualizar o horário
function atualizarHorario() {
    // Limpar tabela anterior
    document.querySelectorAll('.slot').forEach(slot => {
        slot.innerHTML = '';
        slot.classList.remove('ocupado');
        slot.rowSpan = 1;
    });

    // Preencher o horário
    turnosInscritos.forEach(aula => {
        const { uc_nome, turno_nome, tipo, dia, hora_inicio, hora_fim } = aula;
        
        // Calcular quantas células (slots de 30min) a aula ocupa
        const [hi_h, hi_m] = hora_inicio.split(':').map(Number);
        const [hf_h, hf_m] = hora_fim.split(':').map(Number);
        
        const inicio_minutos = hi_h * 60 + hi_m;
        const fim_minutos = hf_h * 60 + hf_m;
        const duracao_slots = (fim_minutos - inicio_minutos) / 30;
        
        // Encontrar a célula inicial
        const celula = document.getElementById(`${dia}-${hora_inicio}`);
        
        if (celula) {
            celula.innerHTML = `
                <div class="aula-bloco">
                    <strong>${uc_nome}</strong><br>
                    <span>${turno_nome} (${tipo})</span><br>
                    <small>${hora_inicio} - ${hora_fim}</small>
                </div>
            `;
            celula.classList.add('ocupado');
            celula.rowSpan = duracao_slots;
            
            // Remover células seguintes que serão ocupadas pelo rowspan
            let proxima = celula.nextElementSibling;
            for (let i = 1; i < duracao_slots; i++) {
                if (proxima) {
                    const proximaLinha = celula.parentElement.nextElementSibling;
                    if (proximaLinha) {
                        const colIndex = Array.from(celula.parentElement.children).indexOf(celula);
                        const celulaRemover = proximaLinha.children[colIndex];
                        if (celulaRemover) celulaRemover.remove();
                    }
                }
            }
        }
    });
}

// Atualizar horário ao carregar a página
atualizarHorario();

function removerDaLista(turnoId, ucId) {
    turnosInscritos = turnosInscritos.filter(
        (t) => !(String(t.turno_id || t.turno_nome || t.turno) === String(turnoId) && String(t.uc_id || t.uc_nome || t.uc) === String(ucId))
    );
}

function marcarOptionDisponivel(card, turnoId) {
    const select = card.querySelector('.turno-select');
    if (!select) return;
    const opt = select.querySelector(`option[value="${turnoId}"]`);
    if (opt) {
        opt.disabled = false;
        opt.classList.remove('option-inscrito');
    }
}

function marcarOptionInscrito(card, turnoId) {
    const select = card.querySelector('.turno-select');
    if (!select) return;
    const opt = select.querySelector(`option[value="${turnoId}"]`);
    if (opt) {
        opt.disabled = true;
        opt.classList.add('option-inscrito');
    }
}

function adicionarBlocoInscrito(card, data) {
    const { turnoId, ucId, ucNome, turnoNome, horario, tipo, dia, hora_inicio, hora_fim } = data;
    const container = card.querySelector('.turnos-inscritos') || document.createElement('div');
    container.classList.add('turnos-inscritos');

    const p = document.createElement('p');
    p.classList.add('inscrito-info');
    p.innerHTML = `
        <i class="fa-solid fa-circle-check"></i>
        Já estás inscrito em <strong>${turnoNome}</strong> (${horario})
    `;

    const a = document.createElement('a');
    a.href = `/turnos/desinscrever/${turnoId}/${ucId}/`;
    a.className = 'btn-remover';
    a.dataset.turnoId = turnoId;
    a.dataset.ucId = ucId;
    a.dataset.ucNome = ucNome;
    a.dataset.turnoNome = turnoNome;
    a.dataset.tipo = tipo || '';
    a.dataset.dia = dia || '';
    a.dataset.horaInicio = hora_inicio || '';
    a.dataset.horaFim = hora_fim || '';
    a.innerHTML = '<i class="fa-solid fa-trash"></i> Remover';

    p.appendChild(a);
    container.innerHTML = '';
    container.appendChild(p);
    if (!container.parentElement) {
        card.appendChild(container);
    }

    anexarHandlerRemover(a);
}

async function anexarHandlerRemover(btn) {
    btn.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!confirm('Desinscrever deste turno?')) return;

        try {
            const resp = await fetch(btn.href, { method: 'GET', redirect: 'follow' });
            if (!resp.ok && resp.status !== 302) {
                throw new Error('Falha ao remover');
            }

            const card = btn.closest('.uc-card');
            const turnoId = btn.dataset.turnoId;
            const ucId = btn.dataset.ucId;

            removerDaLista(turnoId, ucId);
            atualizarHorario();

            const bloco = btn.closest('.turnos-inscritos');
            if (bloco) bloco.remove();

            if (card) marcarOptionDisponivel(card, turnoId);
        } catch (err) {
            console.error('Erro ao desinscrever:', err);
            alert('Erro ao remover inscrição.');
        }
    });
}

// Função para validar inscrição antes de submeter
function validarInscricao(form) {
    const turnoSelect = form.querySelector('.turno-select');
    const selectedOption = turnoSelect.selectedOptions[0];
    const turnoId = turnoSelect.value;
    const ucId = selectedOption.dataset.ucId;
    const ucNome = selectedOption.dataset.ucNome || form.closest('.uc-card')?.querySelector('h3')?.innerText || '';

    if (!turnoId) {
        return true;
    }

    // Verificar conflitos via API
    fetch(`/api/turnos/conflitos/${turnoId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.conflitos && data.conflitos.length > 0) {
                const conflitorAlert = document.getElementById('conflito-alert');
                const conflitorMsg = document.getElementById('conflito-msg');
                
                let mensagem = 'Este turno tem sobreposição com:<br>';
                data.conflitos.forEach(c => {
                    mensagem += `<br>• <strong>${c.uc}</strong> - ${c.turno} (${c.horario})`;
                });
                
                conflitorMsg.innerHTML = mensagem;
                conflitorAlert.style.display = 'block';
                conflitorAlert.scrollIntoView({ behavior: 'smooth' });
                
                // Mostrar pergunta de confirmação
                const confirmar = confirm(
                    'Este turno tem sobreposição de horário com outras inscrições.\n\n' +
                    'Deseja continuar mesmo assim?'
                );
                
                if (confirmar) {
                    submeterInscricao(turnoId, ucId, selectedOption, ucNome, form.closest('.uc-card'));
                }
            } else {
                // Sem conflitos, submeter
                submeterInscricao(turnoId, ucId, selectedOption, ucNome, form.closest('.uc-card'));
            }
        })
        .catch(error => {
            console.error('Erro ao verificar conflitos:', error);
            // Em caso de erro, submeter mesmo assim
            submeterInscricao(turnoId, ucId, selectedOption, ucNome, form.closest('.uc-card'));
        });

    return false;
}

// Função para submeter a inscrição com a ação dinâmica (sem reload)
function submeterInscricao(turnoId, ucId, selectedOption, ucNome, card) {
    const url = `/turnos/inscrever/${turnoId}/${ucId}/`;

    fetch(url, { method: 'GET', redirect: 'follow' })
        .then(resp => {
            if (!resp.ok && resp.status !== 302) {
                throw new Error('Falha ao inscrever');
            }

            const turnoNome = selectedOption.dataset.turnoNome || selectedOption.textContent.trim().split(' — ')[0];
            const tipo = selectedOption.dataset.tipo || '';
            const dia = selectedOption.dataset.dia;
            const hora_inicio = selectedOption.dataset.hora;
            const hora_fim = selectedOption.dataset.horaFim;
            const horarioStr = `${dia} ${hora_inicio}-${hora_fim}`;

            turnosInscritos.push({
                uc_nome: ucNome,
                turno_nome: turnoNome,
                tipo,
                dia,
                hora_inicio,
                hora_fim,
                uc_id: ucId,
                turno_id: turnoId
            });

            atualizarHorario();
            if (card) marcarOptionInscrito(card, turnoId);
            if (card) {
                adicionarBlocoInscrito(card, {
                    turnoId,
                    ucId,
                    ucNome,
                    turnoNome,
                    horario: horarioStr,
                    tipo,
                    dia,
                    hora_inicio,
                    hora_fim
                });
            }
        })
        .catch(err => {
            console.error('Erro ao inscrever:', err);
            alert('Erro ao inscrever no turno.');
        });
}

// Atualizar horário após desinscrever (sem reload)
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.btn-remover').forEach(anexarHandlerRemover);
});

// Exportar PDF
document.getElementById("exportPDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const container = document.getElementById("horarioContainer");

    const canvas = await html2canvas(container, {
        scale: 3,
        backgroundColor: "#FFFFFF",
    });

    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");

    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    pdf.save("horario_personalizado.pdf");
});
</script>

{% endblock %}

